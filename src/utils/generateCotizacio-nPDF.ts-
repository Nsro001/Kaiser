import pdfMake from "pdfmake/build/pdfmake";
import * as pdfFonts from "pdfmake/build/vfs_fonts";

(pdfMake as any).vfs = (pdfFonts as any).pdfMake.vfs;

// ---------------------------------------------------------------------
// LOGO BASE64 INCRUSTADO
// ---------------------------------------------------------------------
const defaultLogo = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABwoAAAIVCAMAAAD2yItrAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAwBQTFRFb43VAD+YIkF2ADigpLC9gJfXcoW0pbj2kqjIUGeTscf9ADiZXnKUobO8vMXHPFexHzhzAD+gQVV4QFeNAECooLTKlaurxMzPBT+Lkqvbxdr/uL/FXnjNtLu/k6Cso6G9u8jV2c/QfuPdp5/bWYLaoK30593x19f0iJukl6W1vanLx93cqqOjADqka2iyX3FwbmZqbnR3d2qK75WvxMHA4tfu5Mnl0cPo2cDQ+PDy+fX19vb2w8PDzc3N0dHRy8vLzc7P5ebn5uXl1dvc8Ozu4OHh3dzlroiJeYlDVWZyQU5gXUheWkpdQ0FeSEldRUxgFktkN0BdSEpiTFRlVmNsV2BuX2d0WWJzY2l4a2x8hYyWf5GchY6WeJWatLS5oKe0kp+zemu6mZ+ztbfAx8jKxMTFZp2pZ6Knm6yurbO5vrzC0szR2dfb39rgrrG2t7fB1drf19vo3uPj29vbysbIz87N19zkzc3L1NjhztTh09bl4eXs5+jw5unv6+3z6u3y7O/z7/H2+Pb5+vf6/fv9/v3+/f7+////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQVj0QAAIABJREFUeNrswYEAAAAAgKD9qRepAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgB/AWAZe1qKowAAAABJRU5ErkJggg==";

// ---------------------------------------------------------------------
// FUNCIÓN PRINCIPAL PARA GENERAR EL PDF
// ---------------------------------------------------------------------
export const generateCotizacionPDF = async ({
    cliente,
    rut,
    direccion,
    email,
    telefono,
    productos,
    margen,
    flete,
    incluirFlete,
    numeroCotizacion,
    fecha,
}) => {

    const effectiveLogo = defaultLogo;

    const itemsTableBody = [
        [
            { text: "Producto", bold: true },
            { text: "Cantidad", bold: true },
            { text: "Costo", bold: true },
            { text: "Precio + Margen", bold: true },
            { text: "Total", bold: true }
        ]
    ];

    let subtotal = 0;

    productos.forEach((p) => {
        const costo = Number(p.costoCompra);
        const precioConMargen = costo + costo * (margen / 100);
        const totalProducto = precioConMargen * p.cantidad;

        subtotal += totalProducto;

        itemsTableBody.push([
            p.nombre,
            p.cantidad,
            `$ ${costo.toLocaleString("es-CL")}`,
                            `$ ${precioConMargen.toLocaleString("es-CL")}`,
                            `$ ${totalProducto.toLocaleString("es-CL")}`
        ]);
    });

    const iva = subtotal * 0.19;
    const total = subtotal + iva + (incluirFlete ? flete : 0);

    const docDefinition = {
        pageMargins: [40, 100, 40, 60],
        header: {
            columns: [
                {
                    image: effectiveLogo,
                    width: 150,
                    margin: [40, 20]
                },
                {
                    text: "Káiser Ingeniería\nCotización Comercial",
                    fontSize: 18,
                    bold: true,
                    alignment: "right",
                    margin: [0, 30, 40, 0]
                }
            ]
        },
        content: [
            {
                text: `COTIZACIÓN N° ${numeroCotizacion}`,
                style: "titulo"
            },
            {
                text: `Fecha: ${fecha}`,
                margin: [0, 0, 0, 20]
            },
            {
                text: "Datos del Cliente",
                style: "subtitulo"
            },
            {
                margin: [0, 0, 0, 10],
                table: {
                    widths: ["auto", "*"],
                    body: [
                        ["Cliente:", cliente],
                        ["RUT:", rut],
                        ["Dirección:", direccion],
                        ["Correo:", email],
                        ["Teléfono:", telefono],
                    ]
                }
            },

            { text: "Detalle de Productos", style: "subtitulo" },

            {
                table: {
                    widths: ["*", 60, 80, 100, 100],
                    body: itemsTableBody
                },
                margin: [0, 10]
            },

            {
                text: "Totales",
                style: "subtitulo"
            },

            {
                table: {
                    widths: ["*", 150],
                    body: [
                        ["Subtotal:", `$ ${subtotal.toLocaleString("es-CL")}`],
                        ["IVA (19%):", `$ ${iva.toLocaleString("es-CL")}`],
                        [
                            incluirFlete ? "Flete:" : "",
                            incluirFlete ? `$ ${flete.toLocaleString("es-CL")}` : ""
                        ],
                        ["TOTAL:", `$ ${total.toLocaleString("es-CL")}`],
                    ]
                },
                margin: [0, 10]
            },

            {
                text: "Condiciones Comerciales",
                style: "subtitulo"
            },
            {
                ul: [
                    "Valores incluyen IVA salvo indicación contraria.",
                    "Validez de la cotización: 5 días.",
                    "Plazo de entrega según disponibilidad.",
                    "Pago mediante transferencia electrónica."
                ]
            }
        ],

        styles: {
            titulo: {
                fontSize: 18,
                bold: true,
                margin: [0, 0, 0, 10]
            },
            subtitulo: {
                fontSize: 14,
                bold: true,
                margin: [0, 15, 0, 5]
            }
        }
    };

    return pdfMake.createPdf(docDefinition);
};
